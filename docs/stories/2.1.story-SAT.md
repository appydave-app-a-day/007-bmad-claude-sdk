# Story 2.1 - Acceptance Test Guide

## Quick Summary

**Story**: Install and Configure Claude Agent SDK
**Status**: Review
**Test Focus**: Verify Claude Agent SDK is installed, authenticated, and initializes successfully on server startup with proper logging and error handling.

## Prerequisites

**Before testing, ensure:**
- [ ] Story status is "Review"
- [ ] Server is NOT running (we'll start it during tests)
- [ ] Dependencies installed (`npm install` completed)
- [ ] Claude Code authentication working (you're authenticated to use this tool)

**Environment Setup:**
- Node.js: 18+
- Port: 3000
- Working directory: `/Users/davidcruwys/dev/ad/appydave-app-a-day/007-bmad-claude-sdk`

---

## üßë Human Tests (Visual/Manual)

Tests requiring human observation - terminal logs, colors, interactive behavior.

### Test 1: AC7 - Console logging shows agent initialization success

**What to test**: Verify server startup logs show Agent SDK initialization with colored logs

**Steps**:
1. Ensure server is NOT running (check port 3000 is free)
2. Run: `npm run dev`
3. Observe terminal output within first 2 seconds of startup

**Expected Result**:
‚úÖ Terminal displays colored log messages in this sequence:
- Blue colored log: `[timestamp] [Server] Initializing Claude Agent SDK... {"component":"AgentSDK"}`
- Blue colored log: `[timestamp] [Server] Agent SDK initialized successfully {"component":"AgentSDK","systemPromptLength":393}`
- Blue colored log: `[timestamp] [Server] Server started on port 3000`
- Blue colored log: `[timestamp] [Server] Health check: http://localhost:3000/api/health`

**Evidence**:
- Terminal screenshot showing blue colored logs with timestamps
- Timestamp format: ISO 8601 (e.g., `[2025-11-15T01:48:15.488Z]`)
- System prompt length: 393 characters

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 2: AC6 - Agent responds to programmatic test query

**What to test**: Verify Agent SDK test query executes successfully during initialization

**Steps**:
1. Server must be running (from Test 1)
2. Observe terminal logs during initialization
3. Look for test query execution (happens automatically inside `initializeAgent()`)

**Expected Result**:
‚úÖ Initialization completes successfully:
- No error messages in terminal
- "Agent SDK initialized successfully" log appears
- Server reaches "Server started on port 3000" without crashes
- Test query executed internally (consumes first message from `query.next()`)

**Evidence**:
- Server startup completes without errors
- Initialization log shows success
- No authentication errors thrown

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 3: AC8 - Error handling for missing authentication

**What to test**: Verify clear error message when authentication is missing

**‚ö†Ô∏è DESTRUCTIVE TEST - Only run if prepared to re-authenticate**

**Steps**:
1. Stop server (Ctrl+C)
2. Temporarily break authentication (this is theoretical - SDK uses Claude Code auth which can't be easily removed)
3. Alternative: Review error handling code in `agent-config.ts` lines 55-61

**Expected Result**:
‚úÖ Code review shows proper error handling:
- Catches authentication errors (line 55: checks for `AUTH_REQUIRED` or `'auth'` in message)
- Logs error with `logger.error()` (line 56-58)
- Throws user-friendly error message (lines 59-61): "Claude authentication required. Please run 'claude auth login' and restart the server."

**Evidence**:
- Code inspection confirms error handling exists
- Error message is clear and actionable

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

## ü§ñ Terminal Tests (Scriptable)

Tests using command-line tools - copy-paste ready commands.

### Test A: AC1 - SDK package installed in server workspace

**What to test**: Verify `@anthropic-ai/claude-agent-sdk` is installed

**Command**:
```bash
grep "@anthropic-ai/claude-agent-sdk" packages/server/package.json
```

**Expected Output**:
```
    "@anthropic-ai/claude-agent-sdk": "^0.1.0",
```

**Validation**:
- ‚úÖ Package appears in dependencies section
- ‚úÖ Version is ^0.1.0 or higher
- ‚úÖ Entry is in `packages/server/package.json`

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test B: AC1 - SDK installed in node_modules

**What to test**: Verify SDK physically installed in node_modules

**Command**:
```bash
ls node_modules/@anthropic-ai/claude-agent-sdk/package.json
```

**Expected Output**:
```
node_modules/@anthropic-ai/claude-agent-sdk/package.json
```

**Validation**:
- ‚úÖ File exists (no error)
- ‚úÖ Path contains `@anthropic-ai/claude-agent-sdk`

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test C: AC9 - TypeScript types imported from SDK

**What to test**: Verify SDK types imported in agent-config.ts

**Command**:
```bash
head -5 packages/server/src/agent/agent-config.ts
```

**Expected Output**:
```typescript
// packages/server/src/agent/agent-config.ts
import type { Options } from '@anthropic-ai/claude-agent-sdk';
import { query } from '@anthropic-ai/claude-agent-sdk';
import { logger } from '../utils/logger.js';
```

**Validation**:
- ‚úÖ Line 2: `import type { Options }` from SDK
- ‚úÖ Line 3: `import { query }` from SDK
- ‚úÖ TypeScript syntax correct

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test D: AC9 - TypeScript compilation succeeds

**What to test**: Verify server workspace compiles with zero TypeScript errors

**Command**:
```bash
npm run build --workspace=@bmad-app/server
```

**Expected Output**:
```

> @bmad-app/server@1.0.0 build
> tsc

(no output = success)
```

**Validation**:
- ‚úÖ Command exits with code 0
- ‚úÖ No TypeScript errors displayed
- ‚úÖ No "error TS" messages

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test E: AC4 - Agent config file exists

**What to test**: Verify agent-config.ts file created in correct location

**Command**:
```bash
ls -lh packages/server/src/agent/agent-config.ts
```

**Expected Output**:
```
-rw-r--r--  1 user  staff   2.7K Nov 15 01:48 packages/server/src/agent/agent-config.ts
```

**Validation**:
- ‚úÖ File exists at exact path
- ‚úÖ File size approximately 2-3KB (89 lines)
- ‚úÖ Created in `packages/server/src/agent/` directory

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test F: AC5 - System prompt configured

**What to test**: Verify SYSTEM_PROMPT constant exists in agent-config.ts

**Command**:
```bash
grep -A 5 "const SYSTEM_PROMPT" packages/server/src/agent/agent-config.ts
```

**Expected Output**:
```typescript
const SYSTEM_PROMPT = `You are a helpful AI assistant that can create and modify web applications through conversation.

You have access to three tools:
- read_json: Read JSON data files
- write_json: Create/update JSON data files
- write_file: Create/update HTML/CSS/JavaScript files
```

**Validation**:
- ‚úÖ `SYSTEM_PROMPT` constant defined
- ‚úÖ Contains tool descriptions (read_json, write_json, write_file)
- ‚úÖ Minimal and educational (not verbose)

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test G: AC3 - README authentication documentation

**What to test**: Verify README.md contains authentication setup instructions

**Command**:
```bash
grep -A 3 "## üîê Authentication Setup" README.md
```

**Expected Output**:
```markdown
## üîê Authentication Setup

This application uses Claude Agent SDK, which requires authentication via Claude CLI OAuth.

### One-Time Setup
```

**Validation**:
- ‚úÖ Section title exists: "Authentication Setup"
- ‚úÖ Mentions Claude CLI OAuth
- ‚úÖ Contains setup instructions

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test H: AC3 - README contains claude auth login instruction

**What to test**: Verify README documents claude auth login command

**Command**:
```bash
grep "claude auth login" README.md
```

**Expected Output**:
```
   claude auth login
# Authenticate (see Authentication Setup above)
claude auth login
- Run `claude auth login` and follow the OAuth flow
- Re-authenticate with `claude auth login`
```

**Validation**:
- ‚úÖ Command appears multiple times (setup + troubleshooting)
- ‚úÖ Exact command: `claude auth login`
- ‚úÖ Context provided (OAuth flow)

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test I: AC2 - No API keys in code

**What to test**: Verify no hardcoded API keys in agent-config.ts

**Command**:
```bash
grep -i "api.key\|apikey\|anthropic.*key" packages/server/src/agent/agent-config.ts
```

**Expected Output**:
```
(no output = no API keys found)
```

**Validation**:
- ‚úÖ No matches found (empty output)
- ‚úÖ Authentication via Claude Code OAuth (not API key)
- ‚úÖ No `.env` file references for API keys

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test J: AC2 - Authentication uses Claude Code OAuth

**What to test**: Verify code comment mentions Claude CLI OAuth

**Command**:
```bash
grep -i "claude.*oauth\|~/.claude" packages/server/src/agent/agent-config.ts
```

**Expected Output**:
```typescript
 * Authenticates using Claude CLI OAuth (must run 'claude auth login' first)
    // Initialize Agent SDK options (authentication via ~/.claude/)
```

**Validation**:
- ‚úÖ Comments mention "Claude CLI OAuth"
- ‚úÖ Comments reference `~/.claude/` directory
- ‚úÖ No API key variable references

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

## ‚è≥ Not Testable Yet

*No acceptance criteria deferred to future stories.*

---

## Test Checklist

Copy this checklist to track overall progress:

**Human Tests:**
- [ ] Test 1: AC7 - Console logging shows initialization success
- [ ] Test 2: AC6 - Agent responds to programmatic test
- [ ] Test 3: AC8 - Error handling for missing auth

**Terminal Tests:**
- [ ] Test A: AC1 - SDK package in package.json
- [ ] Test B: AC1 - SDK in node_modules
- [ ] Test C: AC9 - TypeScript types imported
- [ ] Test D: AC9 - TypeScript compilation succeeds
- [ ] Test E: AC4 - Agent config file exists
- [ ] Test F: AC5 - System prompt configured
- [ ] Test G: AC3 - README authentication section
- [ ] Test H: AC3 - README claude auth login command
- [ ] Test I: AC2 - No API keys in code
- [ ] Test J: AC2 - Authentication uses OAuth

**Overall Status**: ‚¨ú Not Started | üîÑ In Progress | ‚úÖ All Passed | ‚ùå Issues Found

---

## Troubleshooting

### Issue: Server won't start - "port 3000 already in use"
**Symptom**: Error message during `npm run dev`: "EADDRINUSE: address already in use :::3000"
**Solution**:
```bash
# Find process using port 3000
lsof -i :3000

# Kill the process (replace PID with actual process ID)
kill -9 <PID>

# Or kill all node processes
killall node
```

---

### Issue: "Agent SDK initialized successfully" log doesn't appear
**Symptom**: Server starts but no Agent SDK log messages
**Solution**:
1. Check server startup logs for errors
2. Verify `initializeAgent()` is called in `server.ts`
3. Ensure logger utility is working (other logs should show)
4. Check TypeScript compilation succeeded: `npm run build`

---

### Issue: TypeScript compilation errors about "Agent" type
**Symptom**: Build fails with "Module has no exported member 'Agent'"
**Solution**:
- This is expected - SDK exports `query` function and `Options` type, not `Agent` class
- Verify imports use correct types: `import type { Options }` and `import { query }`
- Dev agent already fixed this during implementation

---

### Issue: Authentication errors during initialization
**Symptom**: "Claude authentication required" error in terminal
**Solution**:
- SDK uses Claude Code authentication (you're already authenticated)
- This error should NOT occur if you're running this from Claude Code
- If you see this, it means SDK can't access Claude Code auth
- Verify you're authenticated to Claude Code tool

---

### Issue: Blue colored logs not showing
**Symptom**: Log messages appear but without colors
**Solution**:
- Check terminal supports ANSI colors (most modern terminals do)
- Verify logger utility adds colors (check `logger.ts` implementation)
- Colors are a visual enhancement - test passes if logs appear with correct content

---

## Test Results Summary

**Date Tested**: _________________
**Tester**: _________________

**Results**:
- Human Tests: __ / 3 passed
- Terminal Tests: __ / 10 passed
- Total: __ / 13 passed

**Issues Found**:
1. _________________
2. _________________

**Sign-off**: ‚úÖ Story accepted | ‚ùå Issues require fixes

---

*Generated by Taylor (SAT Guide Creator) from Story 2.1*
