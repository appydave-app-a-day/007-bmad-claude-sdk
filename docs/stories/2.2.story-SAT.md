# Story 2.2 - Acceptance Test Guide

## Quick Summary

**Story**: Create Basic Agent Event Loop
**Status**: Review
**Test Focus**: Validate that the agent event loop handles user messages and returns complete responses via Socket.io without streaming

## Prerequisites

**Before testing, ensure:**
- [ ] Story status is "Review"
- [ ] Server is **not** running (will start during tests)
- [ ] Required dependencies installed (`npm install` already run)
- [ ] Claude CLI authenticated (`claude auth login` completed in Story 2.1)
- [ ] Working directory: `/Users/davidcruwys/dev/ad/appydave-app-a-day/007-bmad-claude-sdk/packages/server`

**Environment Setup:**
- Node.js: 18.0.0 or higher
- Port: 3000 (server), 5173 (Vite - not used in this story)
- Browser: Chrome or Firefox (modern browser with developer tools)

---

## üßë Human Tests (Visual/Manual)

Tests requiring human observation - browser, UI, terminal colors, interactive behavior.

### Test 1: AC6 - Server logs at each stage

**What to test**: Console logging at each stage: "Received message", "Calling Agent SDK", "Agent responded", "Sent response to client"

**Steps**:
1. Open terminal in packages/server directory
2. Run `npm run dev`
3. Observe terminal output during startup
4. Keep terminal visible for subsequent tests

**Expected Result**:
‚úÖ Terminal shows colored log messages in this sequence:
- Blue colored timestamps in ISO 8601 format (e.g., `[2025-11-15T10:00:00.000Z]`)
- `[Server] Static files served from packages/client for /chat route`
- `[Server] Initializing Claude Agent SDK... {"component":"AgentSDK"}`
- `[Server] Agent SDK initialized successfully {"component":"AgentSDK","systemPromptLength":393}`
- `[Server] Server started on port 3000`
- `[Server] Health check: http://localhost:3000/api/health`
- `[Server] Test client: http://localhost:3000/chat`

**Evidence**:
- Terminal screenshot showing blue colored logs
- Timestamp format matches ISO 8601
- All log messages present

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 2: AC3 - Socket.io connection established

**What to test**: Integration with Socket.io - client connects to server

**Steps**:
1. Ensure server is running (from Test 1)
2. Open browser to http://localhost:3000/chat
3. Open browser Developer Tools (F12 or Cmd+Option+I)
4. Click Console tab
5. Observe connection status on page

**Expected Result**:
‚úÖ Browser shows:
- Green colored connection status: "‚úÖ Connected"
- Green background (#d1fae5) with green border
- Browser console log: "Connected to server with ID: [socket-id]"

‚úÖ Terminal shows:
- `[Server] Client connected {"component":"SocketServer","socketId":"[socket-id]"}`

**Evidence**:
- Browser screenshot showing green "‚úÖ Connected" status
- Browser console showing connection log
- Terminal showing "Client connected" log

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 3: AC8 - Complete message flow (Happy Path)

**What to test**: Manual test - Send message from client ‚Üí see console logs ‚Üí receive complete agent response

**Steps**:
1. Ensure server running and browser open to http://localhost:3000/chat
2. Keep terminal visible alongside browser
3. Type in message input: "Hello, can you help me?"
4. Click "Send to Agent" button
5. Observe **terminal logs** in sequence
6. Observe **browser response area**
7. Check browser console (F12 ‚Üí Console tab)

**Expected Result**:

‚úÖ **Terminal logs** (in this order):
1. `[Server] Received user message {"component":"AgentEventLoop","messageId":"msg-[timestamp]","messagePreview":"Hello, can you help me?"}`
2. `[Server] Calling Agent SDK {"component":"AgentEventLoop","messageId":"msg-[timestamp]"}`
3. `[Server] Agent responded {"component":"AgentEventLoop","messageId":"msg-[timestamp]","responsePreview":"[first 100 chars]"}`
4. `[Server] Sent response to client {"component":"SocketServer","messageId":"msg-[timestamp]","responseLength":[number]}`

‚úÖ **Browser behavior**:
- Input field shows: "Processing..." while waiting
- Button becomes disabled during processing
- Response area displays complete agent response
- Input field clears after response received
- Button re-enables after response received

‚úÖ **Browser console logs**:
- `Sending user_message: {content: "Hello, can you help me?", messageId: "msg-[timestamp]"}`
- `Received agent response: {content: "[full response]", messageId: "msg-[timestamp]"}`

**Evidence**:
- Terminal screenshot showing all 4 log messages in sequence
- Browser screenshot showing agent response displayed
- Browser console screenshot showing both logs

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 4: AC2 - Synchronous response (no streaming)

**What to test**: Event loop handles synchronous response - complete message at once, not chunks

**Steps**:
1. From previous test (Test 3), observe how response appears
2. Send another test message: "What is 2 + 2?"
3. Watch response area carefully

**Expected Result**:
‚úÖ Response appears **all at once** (not word-by-word or chunk-by-chunk)
- "Processing..." message
- Then complete response appears immediately
- No gradual text appearance (that's streaming - Story 2.3)

**Evidence**:
- Observation note: "Response appeared all at once, not incrementally"

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 5: AC5 - agent_response event sent

**What to test**: Agent response sent back to client via Socket.io event `agent_response` (complete message)

**Steps**:
1. Keep browser console open (F12 ‚Üí Console)
2. Send test message: "Explain what you do"
3. Check browser console logs

**Expected Result**:
‚úÖ Browser console shows:
```
Sending user_message: {content: "Explain what you do", messageId: "msg-[timestamp]"}
Received agent response: {content: "[full response text]", messageId: "msg-[timestamp]"}
```

‚úÖ The `agent_response` event contains:
- `content`: Complete response text (not chunks)
- `messageId`: Matches the sent message ID

**Evidence**:
- Browser console screenshot showing agent_response event structure

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 6: AC7 - Error handling (disconnect scenario)

**What to test**: Error handling with clear messages logged to console and sent to client via Socket.io

**Steps**:
1. While server and browser are connected, observe connection status
2. In terminal, press Ctrl+C to **stop the server**
3. Observe browser connection status changes
4. Try to send a message: "Test message"
5. Check browser console for error logs

**Expected Result**:

‚úÖ **When server stops**:
- Connection status changes to: "‚ùå Disconnected - Waiting for server..."
- Status has red text (#dc2626), red background (#fee2e2), red border
- Response area shows: "Connection lost. Please check if server is running."
- Response area has red background (#ffe6e6) and red border

‚úÖ **Browser console shows**:
- `Disconnected from server at [ISO timestamp]`

‚úÖ **Attempting to send message**:
- Message cannot be sent (button may be disabled or message doesn't go through)

**Evidence**:
- Browser screenshot showing red disconnection status
- Browser console showing disconnect log

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 7: AC9 - No tools registered

**What to test**: No tools registered yet (tools added in later stories)

**Steps**:
1. Restart server: `npm run dev` in terminal
2. Send message asking agent to use a tool: "Can you create a file called test.json?"
3. Observe agent response and terminal logs

**Expected Result**:
‚úÖ Agent responds but **does not** invoke any file creation tools
- Response might explain it cannot create files
- Terminal does NOT show any tool execution logs
- No files created in project directory

**Evidence**:
- Terminal screenshot showing no tool-related logs
- Agent response text explaining limitation

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 8: AC10 - Educational inline comments

**What to test**: Implementation kept minimal and conceptually simple with inline comments for educational clarity

**Steps**:
1. Open file in editor: `packages/server/src/agent/event-loop.ts`
2. Review file contents for inline comments

**Expected Result**:
‚úÖ File contains:
- File header comments explaining event loop purpose
- Inline comments on handleUserMessage function explaining SDK invocation pattern
- Comments note: "Story 2.2: Synchronous (no streaming)"
- Comments note: "Story 2.3: Will add streaming support"
- Comments note: "Stories 2.4-2.6: Will register tools"

‚úÖ File is minimal:
- Approximately 50-80 lines of code (educational clarity target)
- Clear function structure
- Well-documented

**Evidence**:
- Code review note confirming inline comments present
- Line count: ___ lines

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

## ü§ñ Terminal Tests (Scriptable)

Tests using command-line tools - copy-paste ready commands.

### Test A: AC1 - Event loop file exists

**What to test**: Agent event loop implemented in dedicated module

**Command**:
```bash
ls -la packages/server/src/agent/event-loop.ts
```

**Expected Output**:
```
-rw-r--r--  1 [user]  staff  [size] [date] packages/server/src/agent/event-loop.ts
```

**Validation**:
- ‚úÖ File exists
- ‚úÖ Located in correct path: `packages/server/src/agent/`
- ‚úÖ File name is `event-loop.ts` (kebab-case)

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test B: AC4 - TypeScript compilation

**What to test**: Event loop and server compile without errors

**Command**:
```bash
npm run build --workspace=@bmad-app/server
```

**Expected Output**:
```
> @bmad-app/server@1.0.0 build
> tsc
```
(No error output)

**Validation**:
- ‚úÖ TypeScript compiles successfully
- ‚úÖ No compilation errors
- ‚úÖ `dist/` directory created with compiled JavaScript

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test C: AC5 - Shared types defined

**What to test**: Socket.io event types defined in shared package

**Command**:
```bash
cat packages/shared/src/types.ts | grep -A 3 "UserMessageEvent\|AgentResponseEvent\|ErrorEvent"
```

**Expected Output**:
```typescript
export interface UserMessageEvent {
  event: 'user_message';
  payload: {
    content: string;
--
export interface AgentResponseEvent {
  event: 'agent_response';
  payload: {
    content: string;
--
export interface ErrorEvent {
  event: 'error';
  payload: {
    message: string;
```

**Validation**:
- ‚úÖ `UserMessageEvent` interface defined
- ‚úÖ `AgentResponseEvent` interface defined
- ‚úÖ `ErrorEvent` interface defined
- ‚úÖ All interfaces exported

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test D: AC6 - Logger utility usage

**What to test**: Console logging uses logger utility with component tags

**Command**:
```bash
grep -n "logger\." packages/server/src/agent/event-loop.ts
```

**Expected Output**:
```
[line]: logger.info('Received user message', {
[line]: logger.info('Calling Agent SDK', { component: 'AgentEventLoop', messageId });
[line]: logger.info('Agent responded', {
[line]: logger.error('Agent processing failed', {
```

**Validation**:
- ‚úÖ Uses `logger.info` for normal logs
- ‚úÖ Uses `logger.error` for error logs
- ‚úÖ Includes `component: 'AgentEventLoop'` tag
- ‚úÖ No direct `console.log` usage

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

## ‚è≥ Not Testable Yet

**AC2 (Streaming)**: While we can verify synchronous response works, the actual streaming implementation validation will happen in Story 2.3
**Reason**: This story explicitly implements synchronous (non-streaming) responses
**When**: Story 2.3 - "Add Response Streaming to Event Loop"

**AC4 (Tools)**: Full tool execution testing
**Reason**: No tools registered yet (confirmed in AC9)
**When**: Stories 2.4-2.6 - Custom tool implementation stories

---

## Test Checklist

Copy this checklist to track overall progress:

**Human Tests:**
- [ ] Test 1: Server logs at each stage (AC6)
- [ ] Test 2: Socket.io connection established (AC3)
- [ ] Test 3: Complete message flow - Happy Path (AC8)
- [ ] Test 4: Synchronous response (AC2)
- [ ] Test 5: agent_response event sent (AC5)
- [ ] Test 6: Error handling - disconnect scenario (AC7)
- [ ] Test 7: No tools registered (AC9)
- [ ] Test 8: Educational inline comments (AC10)

**Terminal Tests:**
- [ ] Test A: Event loop file exists (AC1)
- [ ] Test B: TypeScript compilation (AC4)
- [ ] Test C: Shared types defined (AC5)
- [ ] Test D: Logger utility usage (AC6)

**Overall Status**: ‚¨ú Not Started | üîÑ In Progress | ‚úÖ All Passed | ‚ùå Issues Found

---

## Troubleshooting

### Issue: Server won't start - "EADDRINUSE: address already in use :::3000"
**Symptom**: Terminal shows port 3000 already in use error
**Solution**:
```bash
# Kill process on port 3000
lsof -ti:3000 | xargs kill -9

# Then restart server
npm run dev
```

### Issue: "Authentication required" error when sending message
**Symptom**: Terminal shows "Claude authentication required. Run: claude auth login"
**Solution**:
```bash
# Re-authenticate with Claude CLI
claude auth login

# Follow browser prompts
# Restart server after authentication
```

### Issue: Browser shows "‚ùå Disconnected" immediately
**Symptom**: Connection status turns red right after loading page
**Solution**:
- Check server is running in terminal
- Verify no errors in server terminal
- Check browser console for CORS errors
- Try hard refresh (Cmd+Shift+R or Ctrl+Shift+R)

### Issue: Agent response takes very long (> 30 seconds)
**Symptom**: "Processing..." message stays for extended period
**Solution**:
- This is normal for first request (Agent SDK initialization)
- Subsequent requests should be faster
- Check terminal for SDK processing logs
- Ensure stable internet connection (SDK makes API calls)

### Issue: Logs not colored in terminal
**Symptom**: Terminal shows plain text logs without blue timestamps
**Solution**:
- Modern terminals support ANSI colors (default on macOS/Linux)
- If using older terminal, colors may not display
- Functionality still works, just no visual color highlighting

### Issue: Browser console shows "Socket.io error" but no details
**Symptom**: Error event logged but message unclear
**Solution**:
- Check terminal for detailed error logs with stack traces
- Terminal shows full error details from server-side
- Common causes: Agent SDK timeout, auth failure, network issues

---

## Test Results Summary

**Date Tested**: _________________
**Tester**: _________________

**Results**:
- Human Tests: __ / 8 passed
- Terminal Tests: __ / 4 passed
- Total: __ / 12 passed

**Issues Found**:
1. _________________
2. _________________
3. _________________

**Sign-off**: ‚¨ú Story accepted | ‚ùå Issues require fixes

**Comments**:
_________________
_________________
_________________

---

*Generated by Taylor (SAT Guide Creator) from Story 2.2 - Create Basic Agent Event Loop*
