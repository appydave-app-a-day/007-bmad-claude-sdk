# Story 2.1: Install and Configure Claude Agent SDK

## Status

Review

## Story

**As a** developer,
**I want** Claude Agent SDK installed and authenticated,
**so that** I can integrate agent-driven conversational capabilities into the application.

## Acceptance Criteria

1. `@anthropic-ai/claude-agent-sdk` installed in `packages/server` workspace
2. Authentication configured to use Claude CLI OAuth (no API key in code)
3. Documentation added to README: "Run `claude auth login` before starting server"
4. Agent SDK initialization code in `src/agent/agent.ts` or similar module
5. Basic system prompt configured for agent (minimal, can be enhanced later)
6. Agent responds to simple test message when invoked programmatically
7. Console logging shows agent initialization success on server startup
8. Error handling for missing authentication with clear error message
9. TypeScript types imported from SDK for type safety

## Tasks / Subtasks

- [x] Task 1: Install Claude Agent SDK in server workspace (AC: 1)
  - [x] Add `@anthropic-ai/claude-agent-sdk` to `packages/server/package.json`
  - [x] Run `npm install` at root to install SDK
  - [x] Verify SDK installed correctly by checking `node_modules`
  - [x] Import SDK types to verify installation: `import type { Options } from '@anthropic-ai/claude-agent-sdk'`

- [x] Task 2: Create agent configuration module (AC: 4, 5)
  - [x] Create directory: `packages/server/src/agent/`
  - [x] Create file: `packages/server/src/agent/agent-config.ts`
  - [x] Define basic system prompt (minimal, educational clarity)
  - [x] Create `initializeAgent()` function with Agent SDK initialization
  - [x] Export agent options and query helper for use by event loop
  - [x] Add inline comments explaining SDK configuration for educational purposes

- [x] Task 3: Configure Claude CLI OAuth authentication (AC: 2, 8)
  - [x] Add authentication configuration in `agent-config.ts`
  - [x] Use Claude CLI credentials from `~/.claude/` (no API key in code)
  - [x] Add error handling for missing authentication with clear error message
  - [x] Log authentication status on initialization
  - [x] Test authentication: Attempt SDK call, verify error if not authenticated

- [x] Task 4: Integrate agent initialization into server startup (AC: 7)
  - [x] Import `initializeAgent()` in `packages/server/src/server.ts`
  - [x] Call `initializeAgent()` during server startup
  - [x] Add console logging with logger utility: "Agent SDK initialized successfully"
  - [x] Verify initialization completes before server listens on port
  - [x] Add error handling for initialization failures

- [x] Task 5: Create programmatic test for agent response (AC: 6)
  - [x] Create test query in `agent-config.ts` initializeAgent function
  - [x] Send simple test message to agent (e.g., "Hello, can you respond?")
  - [x] Verify response received from SDK
  - [x] Built into initialization - no need to remove

- [x] Task 6: Update README with authentication instructions (AC: 3)
  - [x] Add section: "Authentication Setup"
  - [x] Document `claude auth login` command
  - [x] Explain OAuth flow (browser-based, one-time)
  - [x] Add troubleshooting: "If authentication fails, run claude auth login again"
  - [x] Link to Claude CLI documentation (included in troubleshooting)

- [x] Task 7: Add TypeScript type safety (AC: 9)
  - [x] Import Agent SDK TypeScript types in `agent-config.ts`
  - [x] Define type annotations for agent options
  - [x] Define type annotations for system prompt configuration
  - [x] Verify TypeScript compilation: `npm run build` (zero errors)

## Dev Notes

### Previous Story Insights

From Story 1.4 (Socket.io Real-Time Communication):
- ‚úÖ **Server structure ready** - Express server in `packages/server/src/server.ts` listening on port 3000
- ‚úÖ **Logger utility available** - Use `logger.info()` for Agent SDK initialization messages
- ‚úÖ **Error handling pattern** - Try/catch blocks with user-friendly messages
- ‚úÖ **TypeScript compilation working** - Server workspace compiles successfully
- ‚úÖ **Development workflow** - `npm run dev` starts server with hot reload (tsx watch)
- üìù **Socket.io ready** - WebSocket transport ready for streaming (Story 2.3)
- üìù **No event loop yet** - Agent SDK will be integrated into event loop in Story 2.2

**Key Lessons:**
- Keep code minimal and educational (inline comments explaining SDK usage)
- Progressive enhancement: Install & configure SDK first, integrate into event loop second
- Authentication via Claude CLI OAuth (no API key management complexity)

[Source: docs/stories/1.4.story.md#Dev Agent Record]

### Tech Stack

**Claude Agent SDK:**
- **Package**: `@anthropic-ai/claude-agent-sdk` (latest stable version)
- **Purpose**: Agent execution, custom tool integration, streaming responses, quality gate hooks
- **Installation**: npm package in `packages/server` workspace
- **Authentication**: Claude CLI OAuth (no API key in code)
- **Configuration**: System prompt, tool registration, streaming settings
- **TypeScript Support**: Full TypeScript types included
- [Source: architecture/tech-stack.md#Claude Agent SDK]

**Authentication:**
- **Method**: Claude CLI OAuth (`claude auth login`)
- **Storage**: Credentials stored in `~/.claude/` by CLI
- **Runtime**: Agent SDK loads credentials automatically from CLI storage
- **No API Key**: Never store API keys in code, .env files, or git
- **Single-User**: Localhost-only for MVP, no multi-user auth needed
- [Source: architecture/backend-architecture.md#Authentication and Authorization]

**Logging:**
- **Utility**: Custom logger in `packages/server/src/utils/logger.ts`
- **Pattern**: `logger.info('Agent initialized', { component: 'AgentSDK' })`
- **Levels**: info, warn, error, debug
- **Format**: `[timestamp] [component] message [data]`
- [Source: architecture/tech-stack.md#Logging, architecture/coding-standards.md#Logging Pattern]

### Project Structure

**Files Created in This Story:**
1. `packages/server/src/agent/agent-config.ts` - Agent SDK initialization and configuration

**Files Modified in This Story:**
1. `packages/server/package.json` - Add `@anthropic-ai/claude-agent-sdk` dependency
2. `packages/server/src/server.ts` - Import and call `initializeAgent()` during startup
3. `README.md` - Add authentication setup instructions

**Project Structure After This Story:**
```
bmad-claude-sdk-app/
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îî‚îÄ‚îÄ server/
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ agent/
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ agent-config.ts         # NEW: Agent SDK initialization
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ socket/
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ socket-manager.ts       # Existing from Story 1.4
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.ts               # Existing from Story 1.2
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ server.ts                   # MODIFIED: Call initializeAgent()
‚îÇ       ‚îú‚îÄ‚îÄ package.json                    # MODIFIED: Add SDK dependency
‚îÇ       ‚îî‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ README.md                               # MODIFIED: Add auth instructions
‚îî‚îÄ‚îÄ (other files unchanged)
```
[Source: architecture/unified-project-structure.md]

### Agent SDK Configuration (AC 4, 5)

**Agent Initialization Pattern:**

```typescript
// packages/server/src/agent/agent-config.ts
import { Agent } from '@anthropic-ai/claude-agent-sdk';
import { logger } from '../utils/logger';

// Minimal system prompt for MVP (can be enhanced in later stories)
const SYSTEM_PROMPT = `You are a helpful AI assistant that can create and modify web applications through conversation.

You have access to three tools:
- read_json: Read JSON data files
- write_json: Create/update JSON data files
- write_file: Create/update HTML/CSS/JavaScript files

You help users build their applications by understanding their requirements and using these tools to generate the necessary files.`;

let agentInstance: Agent | null = null;

/**
 * Initialize Claude Agent SDK
 * Authenticates using Claude CLI OAuth (must run 'claude auth login' first)
 * Configures basic system prompt (tools registered in later stories)
 */
export const initializeAgent = async (): Promise<Agent> => {
  try {
    logger.info('Initializing Claude Agent SDK...', { component: 'AgentSDK' });

    // Initialize Agent SDK (authentication via ~/.claude/)
    agentInstance = new Agent({
      systemPrompt: SYSTEM_PROMPT,
      // Tools will be registered in Stories 2.4-2.6
      tools: [],
      // Streaming will be configured in Story 2.3
      streaming: false
    });

    logger.info('Agent SDK initialized successfully', {
      component: 'AgentSDK',
      systemPromptLength: SYSTEM_PROMPT.length
    });

    return agentInstance;
  } catch (error) {
    if ((error as any).code === 'AUTH_REQUIRED') {
      logger.error('Authentication required. Run: claude auth login', {
        component: 'AgentSDK'
      });
      throw new Error(
        'Claude authentication required. Please run "claude auth login" and restart the server.'
      );
    }

    logger.error('Failed to initialize Agent SDK', {
      component: 'AgentSDK',
      error: (error as Error).message
    });
    throw error;
  }
};

/**
 * Get initialized agent instance
 */
export const getAgent = (): Agent => {
  if (!agentInstance) {
    throw new Error('Agent not initialized. Call initializeAgent() first.');
  }
  return agentInstance;
};
```

**Key Configuration Details:**
- System prompt is minimal and educational (can be enhanced later)
- No tools registered yet (added in Stories 2.4-2.6)
- No streaming yet (configured in Story 2.3)
- Authentication via Claude CLI OAuth (no API key in code)
- Clear error messages for missing authentication
- Singleton pattern for agent instance

[Source: architecture/components.md#Agent Event Loop, architecture/backend-architecture.md#Authentication and Authorization]

### Server Integration (AC 7)

**Server Startup Pattern:**

```typescript
// packages/server/src/server.ts
import express from 'express';
import { createServer } from 'http';
import { initializeAgent } from './agent/agent-config';
import { logger } from './utils/logger';

const app = express();
const PORT = 3000;

// ... existing middleware and routes ...

const httpServer = createServer(app);

// Initialize Agent SDK before starting server
const startServer = async () => {
  try {
    // Initialize Agent SDK (Story 2.1)
    await initializeAgent();

    // Start HTTP server
    httpServer.listen(PORT, () => {
      logger.info(`Server started on port ${PORT}`, { component: 'Express' });
      logger.info(`Chat interface: http://localhost:${PORT}/chat`);
    });
  } catch (error) {
    logger.error('Failed to start server', {
      component: 'Express',
      error: (error as Error).message
    });
    process.exit(1);
  }
};

startServer();
```

**Key Changes:**
- Wrap server startup in async function
- Call `initializeAgent()` before `httpServer.listen()`
- Handle initialization errors gracefully
- Exit process with code 1 on failure

[Source: architecture/components.md#Express Server, architecture/backend-architecture.md#Controller Template]

### Authentication Setup (AC 2, 3, 8)

**README.md Documentation:**

```markdown
## Authentication Setup

This application uses Claude Agent SDK, which requires authentication via Claude CLI OAuth.

### One-Time Setup

1. Install Claude CLI (if not already installed):
   ```bash
   npm install -g @anthropic-ai/claude-cli
   ```

2. Authenticate with Claude:
   ```bash
   claude auth login
   ```
   This will open a browser window for OAuth authentication. Sign in with your Claude account (requires Claude Pro or Team subscription).

3. Verify authentication:
   ```bash
   claude auth status
   ```

### Starting the Server

After authentication, start the development server:

```bash
npm run dev
```

The server will initialize the Agent SDK and log "Agent SDK initialized successfully" to the console.

### Troubleshooting

**Error: "Claude authentication required"**
- Run `claude auth login` and follow the OAuth flow
- Restart the server after successful authentication

**Error: "Agent SDK initialization failed"**
- Check that you have an active Claude Pro or Team subscription
- Verify credentials with `claude auth status`
- Re-authenticate with `claude auth login`
```

[Source: architecture/backend-architecture.md#Authentication and Authorization, docs/prd.md#NFR2]

### Testing (AC 6)

**Programmatic Test Pattern:**

```typescript
// packages/server/src/agent/agent-config.ts (or server.ts)

/**
 * TEMPORARY: Test agent response (remove after verification)
 */
const testAgentResponse = async (agent: Agent): Promise<void> => {
  try {
    logger.info('Testing agent response...', { component: 'AgentSDK' });

    const response = await agent.sendMessage('Hello, can you respond?');

    logger.info('Agent test response received', {
      component: 'AgentSDK',
      response: response.text.substring(0, 100) // Log first 100 chars
    });
  } catch (error) {
    logger.error('Agent test failed', {
      component: 'AgentSDK',
      error: (error as Error).message
    });
  }
};

// In initializeAgent() function:
// await testAgentResponse(agentInstance); // Uncomment to test
```

**Test Verification:**
- Send simple test message to agent
- Log response to console
- Verify response contains text (not empty)
- Remove or comment out test code after verification

[Source: architecture/testing-strategy.md#MVP Testing Approach]

### Coding Standards

**Critical Rules for This Story:**
- ‚úÖ **Type Sharing**: Import Agent types from `@anthropic-ai/claude-agent-sdk` (AC 9)
- ‚úÖ **Logging Pattern**: Use `logger.info/error` with component prefix, never `console.log`
- ‚úÖ **Error Handling**: Throw clear error messages for missing authentication
- ‚úÖ **Async/Await**: Use async/await for Agent SDK initialization
- ‚úÖ **200 LOC Target**: Keep agent-config.ts minimal and educational (~50 LOC total)

**Naming Conventions:**
- Files: `agent-config.ts` (kebab-case)
- Functions: `initializeAgent`, `getAgent` (camelCase)
- Constants: `SYSTEM_PROMPT` (UPPER_SNAKE_CASE)

[Source: architecture/coding-standards.md#Critical Fullstack Rules, architecture/coding-standards.md#Naming Conventions]

### TypeScript Configuration (AC 9)

**Type Safety Requirements:**
- Import `Agent` type from SDK: `import type { Agent } from '@anthropic-ai/claude-agent-sdk'`
- Define type annotation for agent instance: `agentInstance: Agent | null`
- Define type annotation for `initializeAgent()`: `Promise<Agent>`
- Verify zero TypeScript compilation errors: `npm run build`

**Shared Types (Future):**
- ChatMessage, SocketEvent types defined in `packages/shared/src/types.ts` (Story 2.2)
- Agent configuration types defined in `agent-config.ts` (this story)

[Source: architecture/components.md#Shared Types Package, architecture/coding-standards.md#Type Sharing]

### Project Structure Notes

**Alignment with Architecture:**
- ‚úÖ Agent configuration in `packages/server/src/agent/agent-config.ts` matches unified project structure
- ‚úÖ No event loop yet (created in Story 2.2: `agent/event-loop.ts`)
- ‚úÖ No tools yet (created in Stories 2.4-2.6: `tools/read-json.ts`, etc.)
- ‚úÖ Logger utility already exists from Story 1.2
- ‚úÖ Socket.io server already exists from Story 1.4 (ready for integration in Story 2.2)

**No Structural Conflicts Detected**

### Testing

**Testing Strategy for This Story:**
- **Manual Testing Only** - No automated test framework for MVP
- Verification steps:
  1. Install Claude Agent SDK (`npm install`)
  2. Create `agent-config.ts` with initialization logic
  3. Integrate into server startup
  4. Run `npm run build` (verify zero TypeScript errors)
  5. Authenticate with `claude auth login`
  6. Start server with `npm run dev`
  7. Verify console logs: "Agent SDK initialized successfully"
  8. Test missing authentication: Delete `~/.claude/`, restart server, verify error message
  9. Test programmatic response: Uncomment test function, verify agent responds
  10. Update README.md with authentication instructions

**Future Test Organization:**
- Unit tests: `packages/server/tests/unit/agent/agent-config.test.ts`
- Integration tests: Verify agent initialization in full server startup flow
- [Source: architecture/testing-strategy.md#Test Organization]

**No Test Framework Required for MVP:**
- Manual verification sufficient for this infrastructure story
- Future: Vitest for unit testing agent initialization
- Future: Integration tests for full agent workflow
- [Source: architecture/testing-strategy.md#MVP Testing Approach]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-15 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-11-15 | 1.1 | Implementation complete - Agent SDK installed and configured | James (Dev Agent) |
| 2025-11-15 | 1.2 | Runtime verification complete - All ACs passed | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No debug log configured (devDebugLog: .ai/debug-log.md not used for this story)

### Completion Notes

**Implementation Summary**:
- Claude Agent SDK v0.1.42 successfully installed via npm
- Discovered SDK uses `query()` function, not `Agent` class (story example was incorrect)
- Implemented using correct SDK API: `query({ prompt, options })` with `Options` type
- Authentication via Claude CLI OAuth (credentials in ~/.claude/)
- Programmatic test query built into initialization to verify auth
- README.md updated with complete authentication setup instructions

**Key Implementation Decisions**:
1. **SDK API Correction**: Story assumed `Agent` class, actual SDK uses `query()` function with `Options`
2. **Type Safety**: Used `Options` type from SDK, mcpServers requires object not array
3. **Auth Testing**: Built test query into `initializeAgent()` to verify auth on startup
4. **Helper Functions**: Created `getAgentOptions()` and `createQuery()` for future event loop use
5. **System Prompt**: Included tool descriptions even though tools not registered yet (Stories 2.4-2.6)

**Testing Notes**:
- TypeScript compilation: ‚úÖ Server workspace compiles with zero errors
- SDK installed correctly: ‚úÖ Verified in node_modules/@anthropic-ai/claude-agent-sdk/
- Types imported: ‚úÖ `Options` and `query` from SDK
- Runtime verification: ‚úÖ PASSED
  - Server started successfully on port 3000
  - Agent SDK initialized successfully (logged: "Agent SDK initialized successfully")
  - System prompt length: 393 characters
  - Health endpoint responding: {"status":"ok"}
  - Test query executed during initialization (AC 6: ‚úÖ)
  - Console logging verified (AC 7: ‚úÖ)
  - Authentication working (SDK authenticated successfully)

**Code Metrics**:
- agent-config.ts: 89 lines (within educational clarity target)
- server.ts modifications: +14 lines (async wrapper + error handling)
- README.md additions: +47 lines (authentication setup section)

**Adherence to Standards**:
- ‚úÖ Logging pattern: Used `logger.info/error` with component: 'AgentSDK'
- ‚úÖ Error handling: Clear auth error messages for missing credentials
- ‚úÖ Async/await: All SDK calls use async/await
- ‚úÖ Type annotations: Full TypeScript type safety with SDK types
- ‚úÖ Naming conventions: kebab-case files, camelCase functions, UPPER_SNAKE_CASE constants

### File List

**Files Created**:
1. `packages/server/src/agent/agent-config.ts` - Agent SDK initialization with Options, test query, helper functions

**Files Modified**:
1. `packages/server/package.json` - Added @anthropic-ai/claude-agent-sdk ^0.1.0 dependency
2. `packages/server/src/server.ts` - Import initializeAgent, async startServer wrapper, error handling
3. `README.md` - Added Authentication Setup section with claude auth login instructions

## QA Results

(To be filled by QA Agent after implementation review)
