# Story 2.7 - Acceptance Test Guide

## Quick Summary

**Story**: Add Conversation Memory to Event Loop
**Status**: Review
**Test Focus**: Agent remembers previous messages in conversation for multi-turn dialogues

## Prerequisites

**Before testing, ensure:**
- [ ] Story status is "Review"
- [ ] Server is not running (stop any existing instances)
- [ ] Dependencies installed (`npm install` from project root)
- [ ] Claude authentication complete (`claude auth login`)

**Environment Setup:**
- Node.js: 18+
- Server Port: 3000
- Chat Interface: http://localhost:3000/chat
- Working directory: `/Users/davidcruwys/dev/ad/appydave-app-a-day/007-bmad-claude-sdk`

---

## üßë Human Tests (Visual/Manual)

Tests requiring human observation - browser, UI, console logs, interactive behavior.

### Test 1: AC6 - Console logging shows conversation history size

**What to test**: Console logs display "Conversation history: N messages" before each agent call

**Steps**:
1. Run `npm run dev` from project root
2. Observe server terminal output
3. Keep terminal visible for next tests

**Expected Result**:
‚úÖ Server starts successfully with log messages:
- `[INFO] Server started on port 3000`
- `[INFO] Health check: http://localhost:3000/api/health`
- `[INFO] Test client: http://localhost:3000/chat`
- No errors in startup logs

**Evidence**:
- Terminal shows colored structured logs
- Server listening on port 3000
- No error messages

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 2: AC7a - Multi-turn conversation: Basic context retention

**What to test**: Agent understands context from previous message in same conversation

**Steps**:
1. Open browser to http://localhost:3000/chat
2. In chat interface, send Message 1: "Add a product called 'Coffee'"
3. Wait for agent response (should create product)
4. Observe server terminal logs for "Conversation history: 0 messages"
5. Send Message 2: "Set the price to $2.50"
6. Wait for agent response
7. Observe server terminal logs for "Conversation history: 2 messages"
8. Agent should understand "Set the price" refers to Coffee product from Message 1

**Expected Result**:
‚úÖ Multi-turn conversation works:
- Message 1: Agent creates Coffee product
- Terminal shows: `Conversation history: 0 messages` (before first message)
- Message 2: Agent updates Coffee product price (not creates new product)
- Terminal shows: `Conversation history: 2 messages` (user + assistant from Message 1)
- Agent references "Coffee" from previous context

**Evidence**:
- Browser chat shows coherent conversation
- Server logs show message count incrementing: 0 ‚Üí 2 ‚Üí 4 messages
- Agent doesn't ask "which product?" - uses Coffee from context

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 3: AC7b - Multi-turn conversation: Reference to previous context

**What to test**: Agent can reference specific items from earlier in conversation

**Steps**:
1. In same browser session as Test 2, send Message 3: "Create 3 products: Sugar, Salt, Pepper"
2. Wait for agent response (should create 3 products)
3. Observe server terminal shows "Conversation history: 4 messages"
4. Send Message 4: "Sugar costs 50 cents"
5. Wait for agent response
6. Observe server terminal shows "Conversation history: 6 messages"

**Expected Result**:
‚úÖ Agent associates price with specific product:
- Message 3: Agent creates 3 products (Sugar, Salt, Pepper)
- Terminal shows: `Conversation history: 4 messages`
- Message 4: Agent updates only Sugar price (not Salt or Pepper)
- Terminal shows: `Conversation history: 6 messages`
- Agent doesn't ask "which product gets 50 cents?" - uses Sugar from context

**Evidence**:
- Browser shows agent updating correct product
- Server logs show message count: 4 ‚Üí 6 ‚Üí 8 messages
- Agent demonstrates understanding of conversation context

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 4: AC8 - Session isolation: Independent conversations

**What to test**: Each Socket.io connection has independent conversation history

**Steps**:
1. Keep first browser tab/window open from Test 2 & 3
2. Open second browser tab/window to http://localhost:3000/chat
3. In second tab, send Message 1: "List all products"
4. Observe agent response (should show only products from first tab's conversation, OR show empty if agent treats as new session)
5. In second tab, send Message 2: "Add a product called Tea"
6. Switch back to first tab
7. In first tab, send Message: "List all products"
8. Compare responses between tabs

**Expected Result**:
‚úÖ Session isolation verified:
- Second tab gets independent socket ID (check server logs)
- Server logs show two different socket IDs with separate histories
- Each tab maintains independent conversation context
- Actions in one tab don't affect the other tab's conversation history

**Evidence**:
- Server logs show two distinct socket IDs
- Terminal shows separate "Socket connected" messages
- Each tab has independent message count in logs

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 5: AC9 - Memory cleared on disconnect

**What to test**: Conversation history deleted from Map when socket disconnects

**Steps**:
1. Note current conversation state in first browser tab (from Tests 2-4)
2. Close first browser tab completely
3. Observe server terminal logs
4. Wait 2 seconds
5. Open new browser tab to http://localhost:3000/chat
6. Send Message: "List all products"
7. Observe agent response and server logs

**Expected Result**:
‚úÖ Memory cleanup verified:
- Closing tab triggers disconnect event
- Server logs show: `Socket disconnected, cleared conversation history` with message count
- Opening new tab creates new socket ID (different from closed tab)
- New conversation starts fresh (message count starts at 0)
- Agent doesn't remember previous tab's conversation

**Evidence**:
- Terminal shows disconnect log with socket ID and message count
- New connection gets different socket ID
- Message count resets to 0 for new connection
- No memory leak (old conversation cleared)

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 6: AC7c - Long conversation memory retention

**What to test**: Agent maintains context throughout 10+ message conversation

**Steps**:
1. Open fresh browser tab to http://localhost:3000/chat
2. Send 10 back-and-forth messages, each building on previous context:
   - Message 1: "Create a product called Milk"
   - Message 2: "Set the price to $3"
   - Message 3: "Add another product called Bread"
   - Message 4: "Bread costs $2"
   - Message 5: "What products do we have?"
   - Message 6: "Increase Milk price by 50 cents"
   - Message 7: "Add Butter for $4"
   - Message 8: "List all products with prices"
   - Message 9: "What's the total value of all products?"
   - Message 10: "Remove the cheapest product"
3. Observe server logs showing message count increasing
4. Monitor server memory usage (Activity Monitor / Task Manager)

**Expected Result**:
‚úÖ Long conversation handling:
- Agent maintains context through all 10+ messages
- Server logs show accurate message count: 0 ‚Üí 2 ‚Üí 4 ‚Üí 6 ‚Üí ... ‚Üí 20 messages
- Agent can reference earlier products (Milk, Bread) in later messages
- Server memory usage remains stable (no memory leak)
- No errors or crashes

**Evidence**:
- Terminal shows message count incrementing correctly
- Agent responses demonstrate full conversation memory
- Server memory stable throughout conversation
- All 10+ messages processed successfully

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

## ü§ñ Terminal Tests (Scriptable)

Tests using command-line tools - copy-paste ready commands.

### Test A: AC10 - TypeScript types compilation

**What to test**: ConversationMessage and ConversationHistory types defined and compile successfully

**Command**:
```bash
cd /Users/davidcruwys/dev/ad/appydave-app-a-day/007-bmad-claude-sdk && npm run build
```

**Expected Output**:
```
> bmad-app@0.1.0 build
> npm run build --workspaces --if-present

> @bmad-app/server@0.1.0 build
> tsc

> @bmad-app/shared@0.1.0 build
> tsc
```

**Validation**:
- ‚úÖ TypeScript compilation succeeds with no errors
- ‚úÖ No type errors related to ConversationMessage or ConversationHistory
- ‚úÖ Build completes successfully for all workspaces

**Status**: ‚úÖ Passed

**Notes**: TypeScript compilation successful. All workspaces built without errors.

---

### Test B: AC2, AC10 - Conversation types exist in shared package

**What to test**: ConversationMessage interface and ConversationHistory type defined in types.ts

**Command**:
```bash
grep -A 10 "interface ConversationMessage" /Users/davidcruwys/dev/ad/appydave-app-a-day/007-bmad-claude-sdk/packages/shared/src/types.ts
```

**Expected Output**:
```typescript
/**
 * Single message in conversation history
 * Used to maintain multi-turn conversation context
 */
export interface ConversationMessage {
  /** Role of the message sender */
  role: 'user' | 'assistant';
  /** Message content */
  content: string;
  /** Optional timestamp (milliseconds since epoch) */
  timestamp?: number;
```

**Validation**:
- ‚úÖ ConversationMessage interface exists
- ‚úÖ Has `role: 'user' | 'assistant'` field
- ‚úÖ Has `content: string` field
- ‚úÖ Has `timestamp?: number` optional field
- ‚úÖ JSDoc comments present

**Status**: ‚úÖ Passed

**Notes**: ConversationMessage interface found with all required fields (role, content, timestamp).

---

### Test C: AC10 - ConversationHistory type alias exists

**What to test**: ConversationHistory type alias defined in types.ts

**Command**:
```bash
grep -A 5 "type ConversationHistory" /Users/davidcruwys/dev/ad/appydave-app-a-day/007-bmad-claude-sdk/packages/shared/src/types.ts
```

**Expected Output**:
```typescript
/**
 * Array of conversation messages
 * Maintained per Socket.io connection for session-based memory
 */
export type ConversationHistory = ConversationMessage[];
```

**Validation**:
- ‚úÖ ConversationHistory type alias exists
- ‚úÖ Defined as `ConversationMessage[]` array type
- ‚úÖ JSDoc comments present

**Status**: ‚úÖ Passed

**Notes**: ConversationHistory type alias found, correctly defined as array of ConversationMessage.

---

### Test D: AC1 - Conversation history Map initialized in server.ts

**What to test**: Map structure created for storing conversation history per socket ID

**Command**:
```bash
grep -B 2 -A 1 "conversationHistories = new Map" /Users/davidcruwys/dev/ad/appydave-app-a-day/007-bmad-claude-sdk/packages/server/src/server.ts
```

**Expected Output**:
```typescript
// Story 2.7: Store conversation history per socket connection (session-based memory)
// Map structure: socket.id ‚Üí array of conversation messages
const conversationHistories = new Map<string, ConversationHistory>();
```

**Validation**:
- ‚úÖ Map variable `conversationHistories` declared
- ‚úÖ Type is `Map<string, ConversationHistory>`
- ‚úÖ Comment explains session-based storage pattern

**Status**: ‚úÖ Passed

**Notes**: Map declared correctly with type Map<string, ConversationHistory>.

---

### Test E: AC3 - User message appended to history

**What to test**: User messages added to conversation history before calling agent

**Command**:
```bash
grep -A 10 "Append user message to history" /Users/davidcruwys/dev/ad/appydave-app-a-day/007-bmad-claude-sdk/packages/server/src/server.ts
```

**Expected Output**:
```typescript
      // Story 2.7: Append user message to history
      const userMessage: ConversationMessage = {
        role: 'user',
        content,
        timestamp: Date.now(),
      };
      history.push(userMessage);
      conversationHistories.set(socket.id, history);

      logger.debug('User message added to history', {
```

**Validation**:
- ‚úÖ User message object created with role, content, timestamp
- ‚úÖ Message pushed to history array
- ‚úÖ History updated in Map with `conversationHistories.set()`
- ‚úÖ Debug log added

**Status**: ‚úÖ Passed

**Notes**: User message correctly appended to history with role, content, timestamp fields.

---

### Test F: AC4 - Agent response appended to history after streaming

**What to test**: Complete agent response added to conversation history after streaming completes

**Command**:
```bash
grep -B 3 -A 8 "Append agent response to history" /Users/davidcruwys/dev/ad/appydave-app-a-day/007-bmad-claude-sdk/packages/server/src/server.ts
```

**Expected Output**:
```typescript
      const assistantMessage = await handleUserMessage(content, messageId, socket, history);

      // Story 2.7: Append agent response to history
      if (assistantMessage) {
        history.push(assistantMessage);
        conversationHistories.set(socket.id, history);

        logger.debug('Agent response added to history', {
          component: 'SocketServer',
          socketId: socket.id,
          messageCount: history.length,
```

**Validation**:
- ‚úÖ Event loop returns assistant message
- ‚úÖ Assistant message pushed to history array
- ‚úÖ History updated in Map
- ‚úÖ Debug log with message count

**Status**: ‚úÖ Passed

**Notes**: Agent response correctly appended to history after streaming completes.

---

### Test G: AC5 - Agent SDK receives conversation history

**What to test**: Event loop passes conversation history to Agent SDK via async generator

**Command**:
```bash
grep -A 25 "createConversationIterable" /Users/davidcruwys/dev/ad/appydave-app-a-day/007-bmad-claude-sdk/packages/server/src/agent/event-loop.ts
```

**Expected Output**:
```typescript
    async function* createConversationIterable(): AsyncGenerator<SDKUserMessage> {
      // Yield each previous user message from history
      for (const msg of history) {
        if (msg.role === 'user') {
          yield {
            type: 'user' as const,
            message: { role: 'user' as const, content: msg.content },
            parent_tool_use_id: null,
            session_id: socket.id,
          };
        }
        // Note: Assistant messages are implicitly maintained by SDK
        // when we yield user messages - SDK maintains full conversation context
      }

      // Yield the new user message
      yield {
        type: 'user' as const,
        message: { role: 'user' as const, content: message },
        parent_tool_use_id: null,
        session_id: socket.id,
      };
    }

    // Call Agent SDK with conversation iterable (not simple string)
```

**Validation**:
- ‚úÖ Async generator function `createConversationIterable()` exists
- ‚úÖ Iterates over history array
- ‚úÖ Yields user messages in SDK format with `type`, `message`, `parent_tool_use_id`, `session_id`
- ‚úÖ Yields new user message at end
- ‚úÖ Passed to `query({ prompt: conversationIterable, ... })`

**Status**: ‚úÖ Passed

**Notes**: Async generator correctly yields conversation history to Agent SDK in proper format.

---

### Test H: AC9 - History cleared on disconnect

**What to test**: Conversation history removed from Map when socket disconnects

**Command**:
```bash
grep -A 10 "disconnect.*=>" /Users/davidcruwys/dev/ad/appydave-app-a-day/007-bmad-claude-sdk/packages/server/src/server.ts
```

**Expected Output**:
```typescript
  socket.on('disconnect', () => {
    // Story 2.7: Clear conversation history to prevent memory leaks
    const history = conversationHistories.get(socket.id);
    const messageCount = history?.length || 0;

    conversationHistories.delete(socket.id);

    logger.info('Socket disconnected, cleared conversation history', {
      component: 'SocketServer',
      socketId: socket.id,
      messageCount,
```

**Validation**:
- ‚úÖ Disconnect event handler exists
- ‚úÖ Retrieves history before deleting (for logging)
- ‚úÖ Calls `conversationHistories.delete(socket.id)`
- ‚úÖ Logs disconnect with socket ID and message count

**Status**: ‚úÖ Passed

**Notes**: Disconnect handler correctly clears conversation history from Map to prevent memory leaks.

---

## Test Checklist

Copy this checklist to track overall progress:

**Human Tests:**
- [ ] Test 1: AC6 - Console logging shows conversation history size
- [ ] Test 2: AC7a - Multi-turn conversation: Basic context retention
- [ ] Test 3: AC7b - Multi-turn conversation: Reference to previous context
- [ ] Test 4: AC8 - Session isolation: Independent conversations
- [ ] Test 5: AC9 - Memory cleared on disconnect
- [ ] Test 6: AC7c - Long conversation memory retention

**Terminal Tests:**
- [x] Test A: AC10 - TypeScript types compilation ‚úÖ
- [x] Test B: AC2, AC10 - Conversation types exist in shared package ‚úÖ
- [x] Test C: AC10 - ConversationHistory type alias exists ‚úÖ
- [x] Test D: AC1 - Conversation history Map initialized ‚úÖ
- [x] Test E: AC3 - User message appended to history ‚úÖ
- [x] Test F: AC4 - Agent response appended to history ‚úÖ
- [x] Test G: AC5 - Agent SDK receives conversation history ‚úÖ
- [x] Test H: AC9 - History cleared on disconnect ‚úÖ

**Overall Status**: üîÑ In Progress (8/8 Terminal Tests Passed, 0/6 Human Tests Pending)

---

## Troubleshooting

### Issue: Server won't start - "Port 3000 already in use"
**Symptom**: Error message when running `npm run dev`
**Solution**:
1. Find process: `lsof -i :3000`
2. Kill process: `kill -9 <PID>`
3. Or use different port: `PORT=3001 npm run dev`

### Issue: Console logs don't show message count
**Symptom**: Terminal shows logs but no "Conversation history: N messages"
**Solution**:
1. Check log level is not set to ERROR only
2. Verify event-loop.ts has logger.info() calls (not logger.debug())
3. Restart server with fresh terminal

### Issue: Browser connection fails
**Symptom**: Chat interface shows "Disconnected" or no response to messages
**Solution**:
1. Check server is running on port 3000
2. Verify browser console for Socket.io errors (F12 ‚Üí Console tab)
3. Check CORS settings allow localhost:3000

### Issue: Agent responses missing from history
**Symptom**: Message count doesn't increment by 2 after each exchange
**Solution**:
1. Verify event-loop.ts returns ConversationMessage (not void)
2. Check server.ts appends returned message to history
3. Look for errors in server logs during streaming

### Issue: Memory not cleared on disconnect
**Symptom**: Disconnect log missing or Map size keeps growing
**Solution**:
1. Verify socket.on('disconnect') handler registered
2. Check browser tab actually closed (not just navigated away)
3. Monitor conversationHistories.size in Node debugger

### Issue: Session isolation not working
**Symptom**: Two browser tabs share conversation history
**Solution**:
1. Hard refresh both tabs (Cmd+Shift+R / Ctrl+Shift+R)
2. Check server logs show different socket IDs
3. Clear browser cookies/localStorage
4. Try incognito/private browsing window for second tab

---

## Test Results Summary

**Date Tested**: _________________
**Tester**: _________________

**Results**:
- Human Tests: 0 / 6 passed (pending manual execution)
- Terminal Tests: 8 / 8 passed ‚úÖ
- Total: 8 / 14 passed (automated tests complete)

**Automated Test Execution Date**: 2025-11-16

**Issues Found**:
- None (all automated tests passed)

**Sign-off**: ‚è≥ Awaiting human test execution | ‚ùå Issues require fixes

---

*Generated by Taylor (SAT Guide Creator) from Story 2.7*
