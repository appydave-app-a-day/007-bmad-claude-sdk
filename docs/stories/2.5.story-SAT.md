# Story 2.5 - Acceptance Test Guide

## Quick Summary

**Story**: Implement Custom Tool: write_json
**Status**: Review
**Test Focus**: Verify write_json tool can create/update JSON files in /data directory with proper path sandboxing, error handling, and logging

## Prerequisites

**Before testing, ensure:**
- [ ] Story status is "Review"
- [ ] Server is not running
- [ ] Required dependencies installed (`npm install` from project root)
- [ ] Claude authentication complete (`claude auth login` - only if running server tests)
- [ ] `data/` directory does not exist (will be created by tests)

**Environment Setup:**
- Node.js: >=18.0.0
- Server Port: 3000 (if running human tests)
- Working directory: `/Users/davidcruwys/dev/ad/appydave-app-a-day/007-bmad-claude-sdk`

---

## ü§ñ Terminal Tests (Scriptable)

Tests using command-line tools - can run without starting server.

### Test A: AC1, AC9 - Tool implementation exists with TypeScript types

**What to test**: Tool file exists and exports writeJsonTool with correct structure

**Command**:
```bash
cat packages/server/src/tools/write-json.ts | grep -E "(export const writeJsonTool|tool\(|filepath.*z\.string|content.*z\.any)"
```

**Expected Output**:
```
export const writeJsonTool = tool(
    filepath: z.string().describe('Relative path to the JSON file within /data directory (e.g., "products.json" or "catalog/items.json")'),
    content: z.any().describe('JavaScript object or array to write as JSON. Will be stringified with 2-space indentation.'),
```

**Validation**:
- ‚úÖ File exists at `packages/server/src/tools/write-json.ts`
- ‚úÖ Exports `writeJsonTool` constant
- ‚úÖ Uses Agent SDK's `tool()` function
- ‚úÖ Parameters use Zod schema (`z.string()`, `z.any()`)

**Status**: ‚úÖ Passed

**Notes**: Tool implementation confirmed with proper TypeScript structure using Zod schemas.

---

### Test B: AC4 - Tool registered with Agent SDK

**What to test**: Tool is imported and registered in agent configuration

**Command**:
```bash
cat packages/server/src/agent/agent-config.ts | grep -E "(import.*writeJsonTool|writeJsonTool|allowedTools.*write_json)"
```

**Expected Output**:
```
import { writeJsonTool } from '../tools/write-json.js';
      tools: [listJsonTool, previewJsonTool, readJsonTool, writeJsonTool],
        'mcp__agent-tools__write_json',    // Story 2.5: Create/update JSON files
```

**Validation**:
- ‚úÖ Tool imported from `../tools/write-json.js`
- ‚úÖ Added to tools array in MCP server creation
- ‚úÖ Added to `allowedTools` array with correct MCP naming: `mcp__agent-tools__write_json`

**Status**: ‚úÖ Passed

**Notes**: Tool properly registered with Agent SDK MCP server.

---

### Test C: AC5 - Tool description documents purpose and restrictions

**What to test**: Tool description is clear and comprehensive

**Command**:
```bash
grep -A 1 "tool(" packages/server/src/tools/write-json.ts | head -2
```

**Expected Output**:
```
export const writeJsonTool = tool(
  'write_json',
  'Write or update a JSON file in the /data directory. Creates directories if needed. Content must be a valid JavaScript object or array.',
```

**Validation**:
- ‚úÖ Description explains purpose (write/update JSON)
- ‚úÖ Mentions path restriction (/data directory)
- ‚úÖ Notes directory creation behavior
- ‚úÖ Specifies content type (object or array)

**Status**: ‚úÖ Passed

**Notes**: Tool description is comprehensive and clearly communicates constraints.

---

### Test D: AC10 - Shared TypeScript types defined

**What to test**: WriteJsonParams interface exists in shared package

**Command**:
```bash
cat packages/shared/src/types.ts | grep -A 4 "WriteJsonParams"
```

**Expected Output**:
```
/**
 * Write JSON Tool Parameters
 * Parameters for write_json tool
 */
export interface WriteJsonParams {
  filepath: string;
  content: any;
}
```

**Validation**:
- ‚úÖ `WriteJsonParams` interface defined
- ‚úÖ Has `filepath: string` property
- ‚úÖ Has `content: any` property
- ‚úÖ Interface is exported for cross-package use

**Status**: ‚úÖ Passed

**Notes**: Shared types maintain type safety across client/server boundary.

---

### Test E: AC3 - Path sandboxing implementation

**What to test**: Tool uses validatePath() for security

**Command**:
```bash
cat packages/server/src/tools/write-json.ts | grep -E "(validatePath|DATA_DIR)"
```

**Expected Output**:
```
import { validatePath } from '../utils/path-validator.js';
const DATA_DIR = path.join(process.cwd(), 'data');
      const fullPath = validatePath(filepath, DATA_DIR);
```

**Validation**:
- ‚úÖ Imports `validatePath` utility
- ‚úÖ Defines `DATA_DIR` constant pointing to `/data`
- ‚úÖ Calls `validatePath(filepath, DATA_DIR)` before file operations
- ‚úÖ Prevents directory traversal attacks

**Status**: ‚úÖ Passed

**Notes**: Path sandboxing properly implemented using established pattern from read_json tool.

---

### Test F: AC6 - Error handling implementation

**What to test**: Tool handles various error types

**Command**:
```bash
cat packages/server/src/tools/write-json.ts | grep -E "(EACCES|TypeError|ToolError|catch)"
```

**Expected Output**:
```
    } catch (error) {
      if ((error as NodeJS.ErrnoException).code === 'EACCES') {
      if (error instanceof TypeError) {
      if (error instanceof ToolError) {
```

**Validation**:
- ‚úÖ Catches permission errors (EACCES)
- ‚úÖ Catches TypeError (invalid JSON content)
- ‚úÖ Catches ToolError (path traversal)
- ‚úÖ Has generic error handler for unexpected errors

**Status**: ‚úÖ Passed

**Notes**: Comprehensive error handling covers all expected failure modes.

---

### Test G: AC2 - Directory creation implementation

**What to test**: Tool creates parent directories as needed

**Command**:
```bash
cat packages/server/src/tools/write-json.ts | grep -A 1 "mkdir"
```

**Expected Output**:
```
      await fs.mkdir(path.dirname(fullPath), { recursive: true });
```

**Validation**:
- ‚úÖ Uses `fs.mkdir()` with `recursive: true` option
- ‚úÖ Creates parent directories before writing file
- ‚úÖ Equivalent to `mkdir -p` behavior

**Status**: ‚úÖ Passed

**Notes**: Supports nested paths like "catalog/electronics.json" with automatic directory creation.

---

### Test H: AC7 - Logging implementation

**What to test**: Tool logs operations with proper component prefix

**Command**:
```bash
cat packages/server/src/tools/write-json.ts | grep -E "logger\.(debug|info|error)"
```

**Expected Output**:
```
      logger.debug(`Writing JSON file: ${fullPath}`, { component: 'Tool:write_json' });
      logger.info(`Successfully wrote ${filepath}`, {
        component: 'Tool:write_json',
        logger.error(errorMsg, { component: 'Tool:write_json' });
        logger.error(errorMsg, { component: 'Tool:write_json' });
        logger.error(error.message, { component: 'Tool:write_json', code: error.code });
      logger.error(errorMsg, { component: 'Tool:write_json' });
```

**Validation**:
- ‚úÖ Uses `logger.debug()` for operation start
- ‚úÖ Uses `logger.info()` for success with metadata
- ‚úÖ Uses `logger.error()` for failures
- ‚úÖ All logs include `component: 'Tool:write_json'`

**Status**: ‚úÖ Passed

**Notes**: Proper structured logging with consistent component naming.

---

## üßë Human Tests (Visual/Manual)

Tests requiring human observation - server running, agent interaction, file inspection.

### Test 1: AC8 - Basic JSON file creation via agent

**What to test**: Agent can create new JSON file and stream confirmation

**Prerequisites**:
- Start server: `npm run dev:server`
- Wait for "Server started on port 3000" message
- Have a client ready (HTML page or curl for socket.io)

**Steps**:
1. Connect to server via Socket.io client
2. Send message: "Create a products.json file with 3 sample products. Each product should have: id, name, price, and description fields."
3. Observe terminal output for tool execution logs
4. Wait for agent response to stream back
5. Check file created: `cat data/products.json`

**Expected Result**:
‚úÖ Terminal shows:
- Blue timestamp in ISO 8601 format
- `[Tool:write_json] Writing JSON file: .../data/products.json` (debug log)
- `[Tool:write_json] Successfully wrote products.json` with metadata (info log showing size and key count)

‚úÖ Agent response streams back:
- Confirmation message mentioning file creation
- File path and success status

‚úÖ File created at `data/products.json`:
- Contains valid JSON
- Has 3 products with required fields
- Formatted with 2-space indentation

**Evidence**:
- Screenshot of terminal showing colored logs with timestamps
- Contents of `data/products.json` file
- Agent response in client

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 2: AC2, AC8 - Nested directory creation

**What to test**: Tool creates parent directories when writing to nested paths

**Prerequisites**:
- Server running from Test 1
- Client connected

**Steps**:
1. Send message: "Create a catalog/electronics.json file with 2 electronic products (laptop and phone)"
2. Observe terminal logs
3. Verify directory created: `ls -la data/catalog/`
4. Verify file created: `cat data/catalog/electronics.json`

**Expected Result**:
‚úÖ Terminal shows:
- Debug log: `Writing JSON file: .../data/catalog/electronics.json`
- Info log: `Successfully wrote catalog/electronics.json` with metadata

‚úÖ Directory created:
- `data/catalog/` directory exists

‚úÖ File created:
- `data/catalog/electronics.json` contains 2 products
- JSON is formatted with 2-space indentation

**Evidence**:
- Terminal screenshot showing successful write
- Directory listing showing `data/catalog/` exists
- Contents of `data/catalog/electronics.json`

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 3: AC8 - File update workflow (read ‚Üí modify ‚Üí write)

**What to test**: Agent can update existing file using multi-tool workflow

**Prerequisites**:
- Server running
- `data/products.json` exists from Test 1

**Steps**:
1. Send message: "Update products.json to add a 4th product: a desk lamp with id 4, price $29.99"
2. Observe terminal logs for multi-tool execution
3. Verify file updated: `cat data/products.json`
4. Count products in file: `cat data/products.json | grep '"id"' | wc -l`

**Expected Result**:
‚úÖ Terminal shows tool execution sequence:
- `[Tool:read_json] Reading JSON file: .../data/products.json` (agent reads current content)
- `[Tool:write_json] Writing JSON file: .../data/products.json` (agent writes updated content)
- Success logs for both operations

‚úÖ File updated:
- Now contains 4 products (not 3)
- 4th product has id 4, name includes "desk lamp", price $29.99
- JSON still formatted with 2-space indentation

‚úÖ Agent response:
- Confirms update operation
- Mentions reading current content first

**Evidence**:
- Terminal screenshot showing read ‚Üí write sequence
- Updated `data/products.json` with 4 products
- Agent confirmation message

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 4: AC8 - Discovery-based update workflow

**What to test**: Agent uses list ‚Üí preview ‚Üí read ‚Üí modify ‚Üí write for complex updates

**Prerequisites**:
- Server running
- Multiple JSON files exist in data/ directory

**Steps**:
1. Send message: "What JSON files exist in the data directory?"
2. Observe agent using `list_json()` tool
3. Send message: "Add a 'category' field to all products in products.json. Set category to 'electronics' for all items."
4. Observe multi-tool workflow execution:
   - `list_json()` to discover files
   - `preview_json('products.json')` to see structure
   - `read_json('products.json')` to get full content
   - `write_json('products.json', updatedData)` to save changes
5. Verify file updated: `cat data/products.json`

**Expected Result**:
‚úÖ Terminal shows complete tool sequence:
- `[Tool:list_json]` execution
- `[Tool:preview_json]` execution
- `[Tool:read_json]` execution
- `[Tool:write_json]` execution

‚úÖ File updated correctly:
- All products now have `"category": "electronics"` field
- Other fields unchanged
- JSON formatting preserved

‚úÖ Agent demonstrates awareness:
- Lists available files before attempting operation
- Uses preview to understand structure
- Reads full content before modifying
- Confirms successful update

**Evidence**:
- Terminal screenshot showing full tool execution sequence
- Before/after comparison of products.json
- Agent's conversational response explaining workflow

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 5: AC6, AC8 - Path traversal attempt blocked

**What to test**: validatePath() prevents directory traversal attacks

**Prerequisites**:
- Server running

**Steps**:
1. Send message: "Create a file at ../etc/config.json with some test data"
2. Observe terminal error log
3. Observe agent response
4. Verify file NOT created: `ls -la ../etc/config.json` (should fail)

**Expected Result**:
‚úÖ Terminal shows:
- Error log: `[Tool:write_json]` with ToolError about path traversal
- Error details include blocked path

‚úÖ Agent response:
- Error message streamed back to client
- Explains path restriction (only /data directory writable)
- Does NOT create the file

‚úÖ File system:
- No file created outside /data directory
- `/data` directory remains secure

**Evidence**:
- Terminal screenshot showing error log
- Agent error response message
- Verification that file was not created

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 6: AC6, AC8 - Invalid JSON content handling

**What to test**: Tool handles content that cannot be stringified to JSON

**Prerequisites**:
- Server running

**Steps**:
1. Send message: "Create a test.json file with a circular reference object" (note: agent may refuse or handle this gracefully)
2. Alternative test: Manually test via code if needed (create circular reference in handler test)
3. Observe how agent and tool handle the error

**Expected Result**:
‚úÖ One of these outcomes:
- Agent recognizes circular reference and refuses to attempt
- OR tool catches TypeError and returns error via CallToolResult
- OR agent handles error gracefully and reports to user

‚úÖ Terminal shows:
- If attempted: Error log with TypeError message
- Clean error handling (no server crash)

‚úÖ No corrupt file created:
- If file exists, it should be empty or not created
- No partial JSON written

**Evidence**:
- Agent's handling of the request
- Terminal logs (if tool was called)
- File system state

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 7: AC7 - Console logging shows metadata

**What to test**: Success logs include file size and content summary

**Prerequisites**:
- Server running
- Fresh terminal view

**Steps**:
1. Send message: "Create a data/sites.json file with an array of 5 website objects. Each should have: name, url, description."
2. Observe terminal output carefully
3. Note the metadata in the success log

**Expected Result**:
‚úÖ Terminal shows:
- Debug log: `Writing JSON file: .../data/sites.json`
- Info log: `Successfully wrote sites.json` with metadata object containing:
  - `size`: Number (bytes of JSON string)
  - `keys`: 5 (array length, since content is array)
- Colored timestamp in ISO 8601 format
- Component prefix: `[Tool:write_json]`

‚úÖ Metadata is accurate:
- File size matches actual file: `wc -c < data/sites.json`
- Key count is 5 (number of items in array)

**Evidence**:
- Terminal screenshot highlighting metadata in success log
- Comparison with actual file size

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

### Test 8: AC8 - JSON formatting (2-space indentation)

**What to test**: Generated JSON files are human-readable with proper formatting

**Prerequisites**:
- Any JSON file created in previous tests

**Steps**:
1. View any created JSON file: `cat data/products.json`
2. Count spaces before first nested key
3. Verify consistent indentation throughout

**Expected Result**:
‚úÖ JSON formatting:
- Root level has no indentation
- First nested level has 2 spaces
- Second nested level has 4 spaces
- Arrays formatted with items on separate lines (for readability)
- No tabs used (only spaces)

‚úÖ Example structure:
```json
{
  "products": [
    {
      "id": 1,
      "name": "Product Name"
    }
  ]
}
```

**Evidence**:
- Contents of any generated JSON file
- Indentation verification (count spaces)

**Status**: ‚¨ú Not Tested | ‚úÖ Passed | ‚ùå Failed

**Notes**: _________________

---

## ‚è≥ Not Testable Yet

**None** - All acceptance criteria for Story 2.5 are testable now.

---

## Test Checklist

Copy this checklist to track overall progress:

**Terminal Tests (Automated):**
- [x] Test A: Tool implementation with TypeScript types (AC1, AC9)
- [x] Test B: Tool registered with Agent SDK (AC4)
- [x] Test C: Tool description complete (AC5)
- [x] Test D: Shared TypeScript types defined (AC10)
- [x] Test E: Path sandboxing implementation (AC3)
- [x] Test F: Error handling implementation (AC6)
- [x] Test G: Directory creation implementation (AC2)
- [x] Test H: Logging implementation (AC7)

**Human Tests (Manual):**
- [ ] Test 1: Basic JSON file creation via agent (AC8)
- [ ] Test 2: Nested directory creation (AC2, AC8)
- [ ] Test 3: File update workflow (AC8)
- [ ] Test 4: Discovery-based update workflow (AC8)
- [ ] Test 5: Path traversal attempt blocked (AC6, AC8)
- [ ] Test 6: Invalid JSON content handling (AC6, AC8)
- [ ] Test 7: Console logging shows metadata (AC7)
- [ ] Test 8: JSON formatting verification (AC8)

**Overall Status**: üîÑ In Progress (8/16 tests complete - all terminal tests passed, human tests pending)

---

## Troubleshooting

### Issue: Server won't start - "Agent not initialized" error
**Symptom**: Server crashes with "Agent not initialized" error
**Solution**:
1. Check Claude authentication: Run `claude auth login`
2. Verify authentication status: Run `claude auth status`
3. Restart server after authentication completes

### Issue: "Permission denied" when writing files
**Symptom**: EACCES error in logs when agent tries to write files
**Solution**:
1. Check `data/` directory permissions: `ls -la data/`
2. Ensure write permissions: `chmod u+w data/`
3. Verify server process has write access to project directory

### Issue: Tool not found - "No tool named write_json"
**Symptom**: Agent reports tool doesn't exist
**Solution**:
1. Verify tool registered in `agent-config.ts`: `grep writeJsonTool packages/server/src/agent/agent-config.ts`
2. Check allowedTools array includes `mcp__agent-tools__write_json`
3. Restart server to reload configuration

### Issue: Path traversal not blocked
**Symptom**: Files created outside /data directory
**Solution**:
1. Check validatePath import: `grep validatePath packages/server/src/tools/write-json.ts`
2. Verify validatePath is called before fs operations
3. Review path-validator.ts for correct implementation

### Issue: JSON files have incorrect formatting
**Symptom**: Files are minified (single line) or have wrong indentation
**Solution**:
1. Check JSON.stringify call: `grep "JSON.stringify" packages/server/src/tools/write-json.ts`
2. Verify second parameter is `null` and third is `2`
3. Correct format: `JSON.stringify(content, null, 2)`

### Issue: No logs appearing in terminal
**Symptom**: Tool executes but no debug/info logs visible
**Solution**:
1. Check logger import: `grep "import.*logger" packages/server/src/tools/write-json.ts`
2. Verify logger.debug/info calls exist in code
3. Check if logger is configured properly in utils/logger.ts
4. Ensure terminal supports colors (some terminals strip color codes)

### Issue: Agent doesn't use multi-tool workflow for updates
**Symptom**: Agent tries to write without reading existing content
**Solution**:
1. Check system prompt in agent-config.ts includes update workflow guidance
2. Explicitly ask agent to "read the file first, then update it"
3. Verify all tools (list, preview, read, write) are in allowedTools array

### Issue: TypeError when writing certain content
**Symptom**: "Invalid content for JSON" error
**Solution**:
1. This is expected for circular references - error handling is working
2. Ensure content is plain objects/arrays (no functions, undefined values, circular refs)
3. Check that error is caught and returned as CallToolResult (not thrown)

---

## Test Results Summary

**Date Tested**: _________________
**Tester**: _________________

**Results**:
- Terminal Tests: 8 / 8 passed ‚úÖ
- Human Tests: __ / 8 passed
- Total: __ / 16 passed

**Issues Found**:
1. _________________
2. _________________

**Sign-off**: ‚¨ú Story accepted | ‚ùå Issues require fixes

---

## Test Data Files

The following test data files may be created during testing:

**Created by Tests:**
- `data/products.json` - Sample product catalog (Test 1, 3, 4)
- `data/catalog/electronics.json` - Nested directory test (Test 2)
- `data/sites.json` - Array test data (Test 7)
- `data/test.json` - Error handling test (Test 6)

**Cleanup Instructions:**
To reset test environment:
```bash
rm -rf data/
```

This will remove all test data files. The directory will be recreated automatically on next write operation.

---

*Generated by Taylor (SAT Guide Creator) from Story 2.5*
